<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPS Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #1e1e1e;
  }
  #map {
    height: calc(100% - 50px);
    width: 100%;
  }
  .top-bar {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 5px;
    background: #111;
    color: white;
  }
  button {
    background: #222;
    color: white;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 5px;
  }
  button:hover {
    background: #444;
  }
</style>
</head>
<body>

<div class="top-bar">
  <button id="btnRTB">Return to Base</button>
  <button id="btnWP">Set WP</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map, marker, pathLine;
let pathCoords = [];
let baseLocation = null; // Store home position

function initMap(lat, lon) {
  map = L.map('map').setView([lat, lon], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  marker = L.marker([lat, lon]).addTo(map).bindPopup("Current Position");
  pathCoords.push([lat, lon]);
  pathLine = L.polyline(pathCoords, {color: 'red'}).addTo(map);

  // Set initial base location
  baseLocation = [lat, lon];
}

function updatePosition(lat, lon) {
  marker.setLatLng([lat, lon]);
  pathCoords.push([lat, lon]);
  pathLine.setLatLngs(pathCoords);
  map.panTo([lat, lon]);
}

// Geolocation API to track position
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    if (!map) {
      initMap(lat, lon);
    } else {
      updatePosition(lat, lon);
    }
  }, err => {
    console.error(err);
    alert("GPS access denied or unavailable.");
  }, {
    enableHighAccuracy: true
  });
} else {
  alert("Geolocation not supported.");
}

// Button actions
document.getElementById("btnRTB").onclick = () => {
  if (baseLocation) {
    map.setView(baseLocation, 15);
    L.marker(baseLocation, {icon: L.icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    })}).addTo(map).bindPopup("Base Location").openPopup();
    window.parent.postMessage({command: "returnToBase", location: baseLocation}, "*");
  }
};

document.getElementById("btnWP").onclick = () => {
  map.once('click', function(e) {
    const wp = [e.latlng.lat, e.latlng.lng];
    L.marker(wp, {icon: L.icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    })}).addTo(map).bindPopup("Waypoint").openPopup();
    window.parent.postMessage({command: "setWaypoint", location: wp}, "*");
  });
};
</script>

</body>
</html>
